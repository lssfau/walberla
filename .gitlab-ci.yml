###############################################################################
##                                                                           ##
##    General settings                                                       ##
##                                                                           ##
###############################################################################

stages:
   - pretest
   - "Code Quality"
   - test
   - documentation
   - deploy
   - benchmark


###############################################################################
##                                                                           ##
##    Build templates                                                        ##
##                                                                           ##
###############################################################################

.build_template:
   script:
      - export NUM_CORES=$(nproc --all)
      - export MAX_BUILD_CORES=$(( $(awk '( $1 == "MemTotal:" ) { print $2 }' /proc/meminfo) / ( 4 * 1024 * 1024  ) ))
      - "[[ $MAX_BUILD_CORES -lt $NUM_CORES ]] && export NUM_BUILD_CORES=$MAX_BUILD_CORES || export NUM_BUILD_CORES=$NUM_CORES"
      - $CXX --version
      - cmake --version
      - ccache --version
      - mpirun --version
      - python3 --version
      - python3 python/mesa_pd.py -y .
      - export CCACHE_BASEDIR=$CI_PROJECT_DIR
      - mkdir $CI_PROJECT_DIR/build
      - cd $CI_PROJECT_DIR/build
      - if command -v ompi_info && dpkg --compare-versions `ompi_info | head -2 | tail -1 | sed 's/[^0-9.]*\([0-9.]*\).*/\1/'` ge 1.10; then export MPIEXEC_PREFLAGS="--allow-run-as-root" ; fi
      - cmake ..
        -DCMAKE_CXX_FLAGS=$CMAKE_CXX_FLAGS
        -DWALBERLA_BUFFER_DEBUG=$WALBERLA_BUFFER_DEBUG
        -DWALBERLA_BUILD_TESTS=ON
        -DWALBERLA_BUILD_BENCHMARKS=ON
        -DWALBERLA_BUILD_TUTORIALS=ON
        -DWALBERLA_BUILD_TOOLS=ON
        -DWALBERLA_BUILD_SHOWCASES=ON
        -DWALBERLA_BUILD_WITH_MPI=$WALBERLA_BUILD_WITH_MPI
        -DWALBERLA_BUILD_WITH_CUDA=$WALBERLA_BUILD_WITH_CUDA
        -DWALBERLA_BUILD_WITH_PYTHON=$WALBERLA_BUILD_WITH_PYTHON
        -DWALBERLA_BUILD_WITH_OPENMP=$WALBERLA_BUILD_WITH_OPENMP
        -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DMPIEXEC_PREFLAGS=$MPIEXEC_PREFLAGS
        -DWALBERLA_DOUBLE_ACCURACY=$WALBERLA_DOUBLE_ACCURACY
        -DWARNING_ERROR=$WARNING_ERROR
        -DWALBERLA_BUILD_WITH_METIS=$WALBERLA_BUILD_WITH_METIS
        -DWALBERLA_BUILD_WITH_PARMETIS=$WALBERLA_BUILD_WITH_PARMETIS
        -DWALBERLA_BUILD_WITH_FFTW=$WALBERLA_BUILD_WITH_FFTW
        -DWALBERLA_BUILD_WITH_HALF_PRECISION_SUPPORT=$WALBERLA_BUILD_WITH_HALF_PRECISION_SUPPORT
        -DWALBERLA_BUILD_WITH_CODEGEN=$WALBERLA_BUILD_WITH_CODEGEN
        -DWALBERLA_STL_BOUNDS_CHECKS=$WALBERLA_STL_BOUNDS_CHECKS
        -DWALBERLA_LOGLEVEL=$WALBERLA_LOGLEVEL
        -DCMAKE_CUDA_ARCHITECTURES=60
      - cmake . -LA
      - make -j $NUM_BUILD_CORES -l $NUM_CORES
      - ctest -LE $CTEST_EXCLUDE_LABELS -C $CMAKE_BUILD_TYPE --output-on-failure -j $NUM_CORES -T Test
   after_script:
      - python3 cmake/ctest2junit.py build > report.xml
   tags:
      - docker
   variables:
      CTEST_EXCLUDE_LABELS: "longrun"
      WALBERLA_BUILD_WITH_MPI: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "ON"
      OMP_NUM_THREADS: "4"
      OMP_WAIT_POLICY: "PASSIVE"
      CMAKE_BUILD_TYPE: "Release"
      WALBERLA_BUFFER_DEBUG: "OFF"
      WALBERLA_DOUBLE_ACCURACY: "ON"
      WALBERLA_BUILD_WITH_METIS: "ON"
      WALBERLA_BUILD_WITH_PARMETIS: "ON"
      WALBERLA_BUILD_WITH_FFTW: "ON"
      WALBERLA_LOGLEVEL: "DETAIL"
      WARNING_ERROR: "ON"
   artifacts:
      when: always
      reports:
         junit:
            - report.xml
            - python/report.xml


###############################################################################
##                                                                           ##
##    Linux builds                                                           ##
##                                                                           ##
###############################################################################


icx_2024_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

icx_2024_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

icx_2024_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
   tags:
      - cuda11
      - docker

icx_2024_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
   tags:
      - cuda11
      - docker

icx_2024_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
   tags:
      - cuda11
      - docker

icx_2024_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
   tags:
      - cuda11
      - docker

icx_2024_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/icx-2024:38
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
   tags:
      - cuda11
      - docker

gcc_10_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_10_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_10_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_10_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_10_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_10_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

gcc_10_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-10:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_11_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_12_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_13_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_13_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

gcc_13_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   stage: pretest
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

gcc_13_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

gcc_13_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

gcc_13_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

gcc_13_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=gcc CXX=g++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_16_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_16_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_16_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_16_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_16_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_16_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_16_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-16:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_17_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_18_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_18_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - cuda11
      - docker

clang_18_hybrid:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_18_serial_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_18_mpionly_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_18_hybrid_dbg:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker

clang_18_hybrid_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:38
   stage: pretest
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - python3 -m pip install lbmpy==1.3.7 jinja2 pytest numpy setuptools lxml
      - cd python
      - python3 -m pytest --junitxml=report.xml pystencils_walberla lbmpy_walberla
      - python3 -m pip list
      - cd ..
      - CC=clang CXX=clang++ ci-venv/bin/python -m pip install cupy-cuda11x
   variables:
      WALBERLA_BUILD_WITH_CUDA: "ON"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      Python_ROOT_DIR: "./ci-venv"
   tags:
      - cuda11
      - docker


###############################################################################
##                                                                           ##
##    Documentation                                                         ##
##                                                                           ##
###############################################################################

doc:
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13
   stage: documentation
   needs: [ ]
   script:
      - cmake --version
      - doxygen --version
      - mkdir $CI_PROJECT_DIR/build
      - cd $CI_PROJECT_DIR/build
      - cmake ..
      - cmake . -LA
      - make doc
   tags:
      - docker
   artifacts:
      paths:
        - build/doc
      expire_in: 1 weeks



###############################################################################
##                                                                           ##
##    Code analysis                                                          ##
##                                                                           ##
###############################################################################

clang-tidy:
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-18:33
   stage: "Code Quality"
   needs: [ ]
   before_script:
      - python3 -m venv ci-venv
      - source ci-venv/bin/activate
      - pip install pyyaml
   script:
      - $CXX --version
      - clang-tidy -version
      - cmake --version
      - mkdir $CI_PROJECT_DIR/build
      - cd $CI_PROJECT_DIR/build
      - cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DWALBERLA_BUFFER_DEBUG=ON -DWALBERLA_BUILD_TESTS=ON -DWALBERLA_BUILD_BENCHMARKS=ON -DWALBERLA_BUILD_TUTORIALS=ON -DWALBERLA_BUILD_TOOLS=ON -DWALBERLA_BUILD_WITH_MPI=ON -DWALBERLA_BUILD_WITH_OPENMP=ON -DCMAKE_BUILD_TYPE=Debug -DWALBERLA_BUILD_WITH_METIS=ON -DWALBERLA_BUILD_WITH_PARMETIS=ON -DWALBERLA_BUILD_WITH_OPENMESH=ON -DWALBERLA_DOUBLE_ACCURACY=ON -DWALBERLA_LOGLEVEL=DETAIL
      - cmake . -LA
      - python3 utilities/clang-tidy/analyze.py -p utilities/clang-tidy/analyze.yml -r $CI_PROJECT_DIR -c compile_commands.json -o clang-tidy-output
   after_script:
      - mkdir -p $CI_PROJECT_DIR/artifacts
      - mv $CI_PROJECT_DIR/build/clang-tidy-output $CI_PROJECT_DIR/artifacts/clang-tidy-output
   artifacts:
      when: always
      paths:
         - $CI_PROJECT_DIR/artifacts/clang-tidy-output
   tags:
      - docker


cppcheck:
   image: i10git.cs.fau.de:5005/walberla/buildenvs/cppcheck
   script:
      - cppcheck --version
      - cppcheck . --max-configs=10 --enable=warning --enable=style --enable=performance --enable=portability -i src/geometry/structured/extern -i sqlite3.c -i StackWalker.cpp -I src/ -I tests/ -I apps/ -D WALBERLA_BUILD_WITH_MPI -D WALBERLA_BUILD_WITH_METIS -D WALBERLA_BUILD_WITH_PYTHON --xml 2> report.xml
      - cppcheck-htmlreport --file=report.xml --report-dir=html_report --source-dir=.
   artifacts:
      untracked: true
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - docker


coverage:
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13
   script:
      - pip3 install gcovr
      - export NUM_CORES=$(nproc --all)
      - export MAX_BUILD_CORES=$(( $(awk '( $1 == "MemTotal:" ) { print $2 }' /proc/meminfo) / ( 4 * 1024 * 1024  ) ))
      - $CXX --version
      - cmake --version
      - gcovr --version
      - mkdir build
      - cd build
      - if dpkg --compare-versions `ompi_info | head -2 | tail -1 | sed 's/[^0-9.]*\([0-9.]*\).*/\1/'` ge 1.10; then export MPIEXEC_PREFLAGS="--allow-run-as-root" ; fi
      - cmake .. -DWALBERLA_BUILD_TESTS=ON -DWALBERLA_BUILD_BENCHMARKS=ON -DWALBERLA_BUILD_TUTORIALS=ON -DWALBERLA_BUILD_WITH_MPI=ON -DWALBERLA_BUILD_WITH_OPENMP=OFF -DCMAKE_BUILD_TYPE=DebugOptimized -DMPIEXEC_PREFLAGS=$MPIEXEC_PREFLAGS -DWALBERLA_BUILD_WITH_CODEGEN=OFF -DWALBERLA_BUILD_WITH_GCOV=ON  -DWALBERLA_LOGLEVEL=DETAIL
      - cmake . -LA
      - make -j $NUM_BUILD_CORES -l $NUM_CORES
      - ctest -LE longrun --output-on-failure -j $NUM_CORES --timeout 3000
      - cd ..
      - mkdir coverage
      - pwd
      - gcovr -r $CI_PROJECT_DIR -k build -f "src" --print-summary --html coverage/coverage.html --html-details --xml coverage/coverage.xml
   coverage: /^\s*lines:\s*\d+.\d+\%/
   artifacts:
      paths:
         - coverage/
      reports:
        coverage_report:
          coverage_format: cobertura
          path: coverage/coverage.xml
   only:
      variables:
         - $ENABLE_NIGHTLY_BUILDS
   tags:
      - docker


###############################################################################
##                                                                           ##
##    macOS Builds                                                           ##
##                                                                           ##
###############################################################################


.mac_build_template: &mac_build_definition
   script:
      - export NUM_CORES=$(system_profiler SPHardwareDataType | grep 'Total Number of Cores' | awk '{print $5}')
      - export MAX_BUILD_CORES=$(( $(system_profiler SPHardwareDataType | grep 'Memory' | awk '{print $2}') / 4 ))
      - "[[ $MAX_BUILD_CORES -lt $NUM_CORES ]] && export NUM_BUILD_CORES=$MAX_BUILD_CORES || export NUM_BUILD_CORES=$NUM_CORES"
      - c++ --version
      - cmake --version
      - mpirun --version
      - mkdir build
      - cd build
      - cmake .. -DWALBERLA_BUILD_TESTS=ON -DWALBERLA_BUILD_BENCHMARKS=ON -DWALBERLA_BUILD_TUTORIALS=ON -DWALBERLA_BUILD_TOOLS=ON -DWALBERLA_BUILD_WITH_MPI=$WALBERLA_BUILD_WITH_MPI -DWALBERLA_BUILD_WITH_PYTHON=$WALBERLA_BUILD_WITH_PYTHON -DWALBERLA_BUILD_WITH_CODEGEN=$WALBERLA_BUILD_WITH_CODEGEN -DWALBERLA_BUILD_WITH_OPENMP=$WALBERLA_BUILD_WITH_OPENMP -DWALBERLA_BUILD_WITH_CUDA=$WALBERLA_BUILD_WITH_CUDA -DWALBERLA_LOGLEVEL=$WALBERLA_LOGLEVEL -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DWARNING_ERROR=ON -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
      - cmake . -LA
      - make -j $NUM_BUILD_CORES -l $NUM_CORES
      - ctest -LE "$CTEST_EXCLUDE_LABELS|cuda" -C $CMAKE_BUILD_TYPE --output-on-failure -j $NUM_CORES -T Test
   after_script:
      - pip3 install lxml
      - python3 cmake/ctest2junit.py build > report.xml
   variables:
      WALBERLA_LOGLEVEL: "DETAIL"
   tags:
      - macmini
   artifacts:
      when: always
      reports:
         junit:
            - report.xml
            - python/report.xml

mac_Serial_Dbg:
   extends: .mac_build_template
   before_script:
     - pip3 install pystencils==1.3.6
     - pip3 install lbmpy==1.3.7
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      CTEST_EXCLUDE_LABELS: "longrun"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"

mac_Serial:
   extends: .mac_build_template
   before_script:
     - pip3 install pystencils==1.3.6
     - pip3 install lbmpy==1.3.7
   variables:
      CMAKE_BUILD_TYPE: "Release"
      CTEST_EXCLUDE_LABELS: "longrun"
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"

mac_MpiOnly_Dbg:
   extends: .mac_build_template
   before_script:
     - pip3 install pystencils==1.3.6
     - pip3 install lbmpy==1.3.7
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      CTEST_EXCLUDE_LABELS: "longrun"
      WALBERLA_BUILD_WITH_MPI: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      OMPI_MCA_btl: "self,tcp"

mac_MpiOnly:
   extends: .mac_build_template
   before_script:
     - pip3 install pystencils==1.3.6
     - pip3 install lbmpy==1.3.7
   variables:
      CMAKE_BUILD_TYPE: "Release"
      CTEST_EXCLUDE_LABELS: "longrun"
      WALBERLA_BUILD_WITH_MPI: "ON"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PYTHON: "ON"
      WALBERLA_BUILD_WITH_CODEGEN: "ON"
      OMPI_MCA_btl: "self,tcp"


###############################################################################
##                                                                           ##
##    Benchmarks                                                             ##
##                                                                           ##
###############################################################################

.benchmark_template: &benchmark_definition
   script:
      - apt-get update --fix-missing
      - apt-get install -y python3-influxdb python3-git
      - $CXX --version
      - cmake --version
      - ccache --version
      - mpirun --version
      - export CCACHE_BASEDIR=$CI_PROJECT_DIR
      - mkdir $CI_PROJECT_DIR/build
      - cd $CI_PROJECT_DIR/build
      - cmake .. -DWALBERLA_BUFFER_DEBUG=OFF -DWALBERLA_BUILD_TESTS=OFF -DWALBERLA_BUILD_BENCHMARKS=ON -DWALBERLA_BUILD_TUTORIALS=OFF -DWALBERLA_BUILD_TOOLS=OFF -DWALBERLA_BUILD_WITH_MPI=ON -DWALBERLA_BUILD_WITH_CUDA=OFF -DWALBERLA_BUILD_WITH_PYTHON=OFF -DWALBERLA_BUILD_WITH_OPENMP=OFF -DCMAKE_BUILD_TYPE=RELEASE -DMPIEXEC_PREFLAGS=$MPIEXEC_PREFLAGS -DWALBERLA_DOUBLE_ACCURACY=ON -DWARNING_ERROR=ON -DWALBERLA_BUILD_WITH_METIS=OFF -DWALBERLA_BUILD_WITH_PARMETIS=OFF -DWALBERLA_OPTIMIZE_FOR_LOCALHOST=ON -DWALBERLA_BUILD_WITH_FASTMATH=ON -DWALBERLA_BUILD_WITH_LTO=ON
      - cmake . -LA
      - cd apps/benchmarks/GranularGas
      - make -j 20
      - export PATH=$PATH:/usr/local/likwid/bin
      - likwid-setFrequencies -t 0
      - likwid-setFrequencies -g performance
      - likwid-setFrequencies -f 3.3 # set frequency to 3.3
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --DEM --syncNextNeighbor | tee GranularGas_DEM_NN.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --DEM --syncShadowOwners | tee GranularGas_DEM_SO.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --HCSITS --syncNextNeighbor --InelasticFrictionlessContact | tee GranularGas_HCSITS_NN_IFC.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --HCSITS --syncNextNeighbor --ApproximateInelasticCoulombContactByDecoupling | tee GranularGas_HCSITS_NN_AICCBD.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --HCSITS --syncNextNeighbor --InelasticCoulombContactByDecoupling | tee GranularGas_HCSITS_NN_ICCBD.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --HCSITS --syncNextNeighbor --InelasticGeneralizedMaximumDissipationContact | tee GranularGas_HCSITS_NN_IGMDC.txt
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./PE_GranularGas PE_Benchmark.cfg --HCSITS --syncShadowOwners --InelasticFrictionlessContact | tee GranularGas_HCSITS_SO_IFC.txt
      - python3 pe_upload.py
      - mpirun --allow-run-as-root -np 8 --map-by core --bind-to core --report-bindings ./MESA_PD_KernelBenchmark MESA_PD_Benchmark.cfg | tee mesa_pd.txt
      - python3 mesa_pd_upload.py
   when: manual
   needs: [ ]
   stage: benchmark
   tags:
      - docker-benchmark
   artifacts:
      paths:
         - $CI_PROJECT_DIR/build/apps/benchmarks/GranularGas/*.txt
         - $CI_PROJECT_DIR/build/apps/benchmarks/GranularGas/*.sqlite

benchmark_intel19:
   <<: *benchmark_definition
   image: i10git.cs.fau.de:5005/walberla/buildenvs/intel-2022

benchmark_gcc8:
   <<: *benchmark_definition
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-13

benchmark_clang8:
   <<: *benchmark_definition
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17

benchmark_ClangBuildAnalyzer:
  script:
    - cmake --version
    - ccache --version
    - mpirun --version
    - export CC=clang
    - export CXX=clang++
    - $CXX --version
    - cd /tmp
    - git clone https://github.com/aras-p/ClangBuildAnalyzer.git
    - cd ClangBuildAnalyzer
    - cmake .
    - make
    - export PATH+=:$(pwd)
    - mkdir $CI_PROJECT_DIR/build
    - cd $CI_PROJECT_DIR/build
    - cmake .. -DWALBERLA_BUFFER_DEBUG=OFF -DWALBERLA_BUILD_TESTS=ON -DWALBERLA_BUILD_BENCHMARKS=ON -DWALBERLA_BUILD_TUTORIALS=ON -DWALBERLA_BUILD_TOOLS=OFF -DWALBERLA_BUILD_WITH_MPI=ON -DWALBERLA_BUILD_WITH_CUDA=OFF -DWALBERLA_BUILD_WITH_PYTHON=OFF -DWALBERLA_BUILD_WITH_OPENMP=OFF -DCMAKE_BUILD_TYPE=RELEASE -DMPIEXEC_PREFLAGS=$MPIEXEC_PREFLAGS -DWALBERLA_DOUBLE_ACCURACY=ON -DWARNING_ERROR=ON -DWALBERLA_BUILD_WITH_METIS=OFF -DWALBERLA_BUILD_WITH_PARMETIS=OFF -DWALBERLA_OPTIMIZE_FOR_LOCALHOST=ON -DWALBERLA_BUILD_WITH_FASTMATH=ON -DWALBERLA_BUILD_WITH_LTO=ON -DCMAKE_CXX_FLAGS=-ftime-trace -G Ninja
    - cmake . -LA
    - ClangBuildAnalyzer --start .
    - ninja all
    - ClangBuildAnalyzer --stop . CBA
    - ClangBuildAnalyzer --analyze CBA
  image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-17
  tags:
    - docker-benchmark
  only:
     variables:
        - $ENABLE_NIGHTLY_BUILDS

continuous_benchmark_trigger:
  stage: benchmark
  image: curlimages/curl
  tags:
    - docker
  script:
    - curl
      --fail
      --request POST
      --form "token=$CB_TRIGGER_TOKEN"
      --form "ref=master"
      --form "variables[WALBERLA_GITLAB_INSTANCE]=https://$CI_SERVER_HOST"
      --form "variables[WALBERLA_PROJECT_ID]=$CI_PROJECT_PATH"
      --form "variables[WALBERLA_BRANCH]=$CI_COMMIT_BRANCH"
      --form "variables[WALBERLA_COMMIT]=$CI_COMMIT_SHA"
      "$CB_TRIGGER_API_URL"
  rules:
    - if: '$CI_PROJECT_PATH == "walberla/walberla" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"
      when: manual
      allow_failure: true